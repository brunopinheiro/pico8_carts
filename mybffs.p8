pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
-- utils
function ite(s,t,f)
	if s then return t else return f end
end

function clamp(x,minx,maxx)
	return min(maxx,max(minx,x))
end

function norm(v,minv,maxv)
	return (v-minv)/(maxv-minv)
end

function arraysel(a,n)
	return ite(
		(n<0 or n>=1),
		a[1],
		a[flr(n*#a)+1]
	)
end

function fade(l, draw)
	-- fade level mapping
	local m={
	 {{6,5}},
	 {{6,2}},
	 {{6,1}},
	 {{6,0}}
	}
	if l > 0 and l < #m then
		for _,cs in ipairs(m[l]) do
			pal(cs[1],cs[2])
		end
	end
	draw()
	pal() --reset after draw call
end

function anim(sprs,e,d)
	return arraysel(
		sprs,
		norm(e%d,0,d)
	)
end

function blink(c1,c2,e,d,n)
	return ite(
		flr(e/(d/(n+1)))%2==0,
		c1,
		c2
	)
end

function lin_ease(i,f,e,d)
	return i+(f-i)*clamp((e/d),0,1)
end

function incubic_ease(i,f,e,d)
	return (f-i) * ((e/d)^3) + i
end


-- flags
function enable(fs,f)
	return bor(fs,f)
end

function disable(fs,f)
	return band(fs,bnot(f))
end

function enabled(fs,f)
	return band(fs,f) > 0
end
-->8
-- game objects
function game_objects()
	local objs = {}
	return {
		add_obj=function(o)
			add(objs,o)
		end,
		remove_obj=function(o)
			del(objs,o)
		end,
		update=function()
			local dt = {}
			for _,o in pairs(objs) do
				if o.update() then
					add(dt,o)
				end
			end
			for _,dto in pairs(dt) do
				del(objs,dto)
			end
		end,
		draw=function()
			for _,o in pairs(objs) do
				o.draw()
			end
		end
	}
end

function noise_txt(txt,x,y,callback)
	local c,f,lt,ly = 0,0,t(),y
	return {
		update=function()
			local e=t()-lt
			if e < 2 then
				ly=lin_ease(y,y-10,e,2)
				c=blink(6,7,e,2,10)
			else
				f = flr(incubic_ease(0,3,e-2,1))
				c = 6
			end
			return e > 3
		end,
		draw=function()
			fade(f, function()
				spr(1, x-10, ly-1)
				print(txt,x,ly,c)
			end)
		end
	}
end

-->8
-- player

function player()
	local pfs=0 -- player flags
	local x,y,s=64,64,.5
	local animt,animd,cs=0,1,16
	return {
		update=function()
			local mx,my=0,0
			mx=ite(btn(0),-s,0)+ite(btn(1),s,0)
		 my=ite(btn(2),-s,0)+ite(btn(3),s,0)
			s=ite(btn(4),1,.5)
			animd=ite(btn(4),.5,1)		
			if mx ~= 0 or my ~= 0 then
				animt=ite(
					animt~=0,
					animt,
					t()
				)
				sprs=ite(
					btn(4),
					{16,33,32},
					{16,17,33}
				)
				cs=anim(sprs,t()-animt,animd)
				pfs=ite(mx<0,enable,disable)(pfs,0b1)
			else
				cs=16
				animt=0
			end
			x+=mx
			y+=my
		end,
		draw=function()
			spr(
				cs,x,y,
				1,1,
				enabled(pfs,0b1),false
			)
		end
	}
end
-->8
-- game loop
local go = game_objects()

function _init()
	go.add_obj(
		player()
	)
end

function _update60()
	go.update()
end

function _draw()
	cls()
	go.draw()
end
__gfx__
00000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000060060060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700660006060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077006660606060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077006660606060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700660006060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000060060060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00055000000550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00577000005770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00577000005770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00766700007667000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00766600006766000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00666600006666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0005d00000d005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00055000000550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00577000005770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05577000005770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00766700007667000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07666670076666700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00666600006666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
050000d000500d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
